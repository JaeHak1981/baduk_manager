rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 모든 요청에 대해 인증된 사용자여야 함
    function isAuthenticated() {
      return request.auth != null;
    }

    // 개발자 권한 확인 (사용자 문서의 role 필드 확인)
    function isDeveloper() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'developer';
    }

    // 학원 소속 멤버십 또는 소유권 확인 (데이터 조회 시)
    function isMember(acaId) {
      let userDoc = /databases/$(database)/documents/users/$(request.auth.uid);
      let academyDoc = /databases/$(database)/documents/academies/$(acaId);
      return isAuthenticated() && acaId != null && (
        (exists(userDoc) && get(userDoc).data.academyId == acaId) ||
        (exists(academyDoc) && get(academyDoc).data.ownerId == request.auth.uid)
      );
    }

    // users 컬렉션: 본인 정보만 접근 가능 (개발자는 전체 조회 가능)
    match /users/{userId} {
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow read, update, delete: if isAuthenticated() && (request.auth.uid == userId || isDeveloper());
    }

    // academies 컬렉션: 소유자 또는 개발자 접근 가능
    match /academies/{academyId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());

      // 하위 schedules 컬렉션 규칙 추가
      match /schedules/{scheduleId} {
        allow read, write: if isAuthenticated() && (get(/databases/$(database)/documents/academies/$(academyId)).data.ownerId == request.auth.uid || isDeveloper());
      }
    }

    // students 컬렉션: 소유자 또는 개발자 접근 가능
    match /students/{studentId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // textbooks 컬렉션: 소유자, 개발자 또는 공용(common) 데이터 접근 가능
    match /textbooks/{textbookId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (resource.data.ownerId == 'common' || resource.data.ownerId == request.auth.uid || isDeveloper());
      allow update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // studentProgress 컬렉션: 소유자 또는 개발자 접근 가능
    match /studentProgress/{progressId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // attendance 컬렉션: 소유자 또는 개발자 접근 가능
    match /attendance/{attendanceId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // orders 컬렉션: 소유자 또는 개발자 접근 가능
    match /orders/{orderId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // temporaryOrders 컬렉션: 학원 소유자, 소속 선생님 또는 개발자 접근 가능
    match /temporaryOrders/{academyId} {
      allow read, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.academyId == academyId) ||
        isDeveloper()
      );
      allow create, update: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.academyId == academyId) ||
        isDeveloper()
      );
    }

    // educationReports 컬렉션: 소유자, 멤버(선생님), 개발자 접근 가능
    match /educationReports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid || 
        isMember(resource.data.academyId) || 
        isDeveloper()
      );
      allow create, update, delete: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid || 
        isMember(request.resource.data.academyId) || 
        isDeveloper()
      );
    }

    // commentTemplates 컬렉션: 소유자, 멤버(선생님), 개발자 접근 가능
    match /commentTemplates/{templateId} {
      allow read: if isAuthenticated() && (
        resource.data.academyId == 'system' || // 시스템 공용 템플릿
        resource.data.ownerId == request.auth.uid || 
        isMember(resource.data.academyId) || 
        isDeveloper()
      );
      allow create, update, delete: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid || 
        isMember(request.resource.data.academyId) || 
        isDeveloper()
      );
    }

    // system_config 컬렉션: 모든 인증된 사용자 읽기 가능, 개발자만 수정 가능
    match /system_config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isDeveloper();
    }
  }
}

