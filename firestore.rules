rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 모든 요청에 대해 인증된 사용자여야 함
    function isAuthenticated() {
      return request.auth != null;
    }

    // 개발자 권한 확인 (사용자 문서의 role 필드 확인)
    function isDeveloper() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'developer';
    }

    // users 컬렉션: 본인 정보만 접근 가능 (개발자는 전체 조회 가능)
    match /users/{userId} {
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow read, update, delete: if isAuthenticated() && (request.auth.uid == userId || isDeveloper());
    }

    // academies 컬렉션: 소유자 또는 개발자 접근 가능
    match /academies/{academyId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // students 컬렉션: 소유자 또는 개발자 접근 가능
    match /students/{studentId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // textbooks 컬렉션: 소유자, 개발자 또는 공용(common) 데이터 접근 가능
    match /textbooks/{textbookId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (resource.data.ownerId == 'common' || resource.data.ownerId == request.auth.uid || isDeveloper());
      allow update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // studentProgress 컬렉션: 소유자 또는 개발자 접근 가능
    match /studentProgress/{progressId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // attendance 컬렉션: 소유자 또는 개발자 접근 가능
    match /attendance/{attendanceId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }

    // orders 컬렉션: 소유자 또는 개발자 접근 가능
    match /orders/{orderId} {
      allow create: if isAuthenticated() && (request.resource.data.ownerId == request.auth.uid || isDeveloper());
      allow read, update, delete: if isAuthenticated() && (resource.data.ownerId == request.auth.uid || isDeveloper());
    }
  }
}

